<blueprint>

    <data name="storage" value="run readLocalStorage" prop="true" />
    <data name="storageView" />
    <data name="activeCount"  />
    <data name="completedCount" />
    <data name="filter" value="noFilter" />
    <data name="markAllToggleStatus" value="bool false" />

    <command name="cmd_MarkTodo" need="storage" transform="markTodo" pipe="storage" />
    <command name="cmd_CreateTodo" need="storage" transform="createTodo" pipe="storage" />
    <command name="cmd_DestroyTodo" need="storage" transform="destroyTodo" pipe="storage" />
    <command name="cmd_MarkAll" toggle="markAllToggleStatus" />
    <command name="cmd_MarkAll" need="markAllToggleStatus,storage" transform="markAll" pipe="storage" />

    <command name="cmd_ClearCompleted" need="storage" transform="clearCompleted" pipe="storage" />
    <command name="cmd_Refresh" need="storage" extract="storage" pipe="storage" />

    <sensor watch="storage" run="writeLocalStorage"  />
    <sensor watch="storage" transform="toActiveCount" pipe="activeCount" />
    <sensor watch="storage" transform="toCompletedCount" pipe="completedCount" />

    <sensor watch="filter" need="storage" transform="filterView" pipe="storageView" />

</blueprint>

<script>

    $.cog({

        methodGet: {method: 'get'},

        LOCAL_STORAGE_NAME: "todo_mvc_cognition",

        readLocalStorage: function(){

            var result = JSON.parse(localStorage.getItem(this.LOCAL_STORAGE_NAME) || '[]');
            return result;
        },

        writeLocalStorage: function(msg){
            localStorage.setItem(this.LOCAL_STORAGE_NAME, JSON.stringify(msg));
        },

        destroyTodo: function (msg) {

            msg.storage.splice(msg.storage.indexOf(msg.cmd_DestroyTodo), 1);
            return msg.storage;

        },

        markAll: function (msg) {

            var storage = msg.storage;
            var status = msg.markAllToggleStatus;

            return storage.map(function(todo){
                todo.completed = status;
                return todo;
            });

        },

        markTodo: function (msg) {
            msg.cmd_MarkTodo.completed = !msg.cmd_MarkTodo.completed;
            return msg.storage;
        },

        toCount: function(msg){
            return msg.length;
        },

        createTodo: function (msg) {

            var todo = {text: msg.cmd_CreateTodo, completed: false};
            msg.storage.push(todo);
            return msg.storage;

        },

        clearCompleted: function (msg) {
            return msg.storage.filter(this.activeFilter);
        },

        toCompletedCount: function(msg){
            return msg.filter(this.completedFilter).length;
        },

        toActiveCount: function(msg){
            return msg.filter(this.activeFilter).length;
        },

        completedFilter: function (d) {
            return d.completed;
        },

        activeFilter: function (d) {
            return !d.completed;
        },

        noFilter: function(){
            return true;
        },

        filterView: function(msg) {

            var filterMethod = this[msg.filter];
            var result = msg.storage.filter(filterMethod);
            return result;
        }

    });

</script>